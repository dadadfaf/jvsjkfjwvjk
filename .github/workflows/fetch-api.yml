name: Fetch API Data

on:
  schedule:
    # Runs every 5 minutes (cron syntax)
    - cron: '*/5 * * * *'
  # Allows manual triggering
  workflow_dispatch:
  # Runs on push to main branch
  push:
    branches: [ main ]

jobs:
  fetch-and-save:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        # This ensures we have the previous api.json for comparison
        fetch-depth: 2

    - name: Fetch data from URL
      id: fetch-data
      env:
        TARGET_URL: ${{https://footyfeed-ten.vercel.app/api?user=valverdeae}}  # Set your URL as a secret
      run: |
        # Fetch data using curl
        echo "Fetching data from $TARGET_URL"
        
        # Create response with timestamp
        timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # Fetch data and add timestamp
        curl -s -f -L "$TARGET_URL" | jq --arg ts "$timestamp" '. + {_fetched_at: $ts}' > api_new.json
        
        # Check if curl was successful
        if [ $? -eq 0 ]; then
          echo "Data fetched successfully"
          
          # Compare with existing file (optional - only commit if changed)
          if cmp -s api_new.json api.json 2>/dev/null; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            mv api_new.json api.json
          fi
        else
          echo "Failed to fetch data"
          exit 1
        fi

    - name: Commit and push if changed
      if: steps.fetch-data.outputs.has_changes == 'true'
      run: |
        # Configure git
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add and commit the file
        git add api.json
        git commit -m "Update api.json - $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
        
        # Push changes
        git push
